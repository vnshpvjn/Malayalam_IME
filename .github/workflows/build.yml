name: Build Malayalam IME

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuildArchitecture: x64
        
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Add MSBuild to PATH
      run: |
        Write-Host "Adding MSBuild to PATH"
        Add-Content -Path $env:GITHUB_PATH -Value "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64"
        
    - name: Build Malayalam IME
      run: |
        cd cpp
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Building Malayalam IME..."
        
        # Try MSBuild first
        if (Test-Path "MalayalamIME.sln") {
          Write-Host "Using MSBuild with solution file..."
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" MalayalamIME.sln /p:Configuration=Release /p:Platform=x64
        } else {
          Write-Host "Using direct compilation..."
          # Fallback to direct compilation
          $vcvars = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          & $vcvars
          
          # Create output directory
          New-Item -ItemType Directory -Force -Path "Release"
          
          # Compile
          & cl /LD MalayalamIME.cpp Register.cpp /FoRelease\ /DWIN32_LEAN_AND_MEAN /DUNICODE /D_UNICODE /DWINVER=0x0601 /D_WIN32_WINNT=0x0601 /link /DLL /SUBSYSTEM:WINDOWS /OUT:MalayalamIME.dll /DEF:MalayalamIME.def user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib
        }
        
    - name: Check build output
      run: |
        cd cpp
        Write-Host "Checking for build artifacts..."
        Get-ChildItem -Path . -Name "*.dll" -Recurse
        Get-ChildItem -Path . -Name "*.lib" -Recurse
        Get-ChildItem -Path . -Name "*.pdb" -Recurse
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MalayalamIME-Build-x64
        path: |
          cpp/MalayalamIME.dll
          cpp/MalayalamIME.lib
          cpp/MalayalamIME.exp
          cpp/MalayalamIME.pdb
        retention-days: 30
        
    - name: Upload installer files
      uses: actions/upload-artifact@v3
      with:
        name: MalayalamIME-Installer-Files
        path: |
          cpp/*.bat
          cpp/*.md
          cpp/MalayalamIME.def
          cpp/MalayalamIME.rc
        retention-days: 30

  build-minimal:
    runs-on: windows-latest
    if: failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Build with minimal dependencies
      run: |
        cd cpp
        Write-Host "Attempting minimal build..."
        
        # Create output directory
        New-Item -ItemType Directory -Force -Path "Release"
        
        # Minimal compilation without ATL
        & cl /LD MalayalamIME.cpp Register.cpp /FoRelease\ /DWIN32_LEAN_AND_MEAN /DUNICODE /D_UNICODE /DWINVER=0x0601 /D_WIN32_WINNT=0x0601 /D_CRT_SECURE_NO_WARNINGS /link /DLL /SUBSYSTEM:WINDOWS /OUT:MalayalamIME-minimal.dll /DEF:MalayalamIME.def user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib comctl32.lib shlwapi.lib
        
    - name: Upload minimal build
      uses: actions/upload-artifact@v3
      with:
        name: MalayalamIME-Minimal-Build
        path: cpp/MalayalamIME-minimal.dll
        retention-days: 30
