name: Build Malayalam IME

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Display repository structure
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -Directory -Force
        Write-Host "=== C++ Files Found ==="
        Get-ChildItem -Recurse -Filter "*.cpp" -Name
        Get-ChildItem -Recurse -Filter "*.h" -Name

    - name: Build Malayalam IME
      run: |
        Write-Host "=== Starting Malayalam IME Build Process ==="
        
        # Step 1: Verify source files exist
        $sourceFiles = @(
          "src\MalayalamIME.cpp",
          "src\Register.cpp", 
          "src\MalayalamIME.h",
          "src\stdafx.h"
        )
        
        Write-Host "Checking required source files..."
        foreach ($file in $sourceFiles) {
          if (Test-Path $file) {
            Write-Host "âœ“ Found: $file"
          } else {
            Write-Host "âœ— ERROR: Missing required file: $file"
            exit 1
          }
        }
        
        # Step 2: Find Visual Studio installation
        Write-Host "Finding Visual Studio 2022..."
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        
        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
          Write-Host "Visual Studio Path: $vsPath"
        } else {
          Write-Host "Trying Community edition..."
          $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Community -latest -property installationPath
          if ($vsPath) {
            Write-Host "Community Edition Path: $vsPath"
          } else {
            Write-Host "âœ— ERROR: Visual Studio 2022 not found!"
            exit 1
          }
        }
        
        $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
        Write-Host "VCVARS64: $vcvars64"
        
        # Step 3: Create output directory
        $outputDir = "build-output"
        if (!(Test-Path $outputDir)) {
          New-Item -ItemType Directory -Force -Path $outputDir
          Write-Host "Created output directory: $outputDir"
        }
        
        # Step 4: Create comprehensive build script
        Write-Host "Creating build script..."
        $buildScript = @"
        @echo off
        echo ========================================
        echo    Malayalam IME Build Script
        echo ========================================
        
        echo Setting up Visual Studio environment...
        call "$vcvars64" x64
        if %ERRORLEVEL% NEQ 0 (
          echo ERROR: Failed to set up Visual Studio environment
          exit 1
        )
        
        echo Environment setup complete
        echo Current directory: %CD%
        
        echo Verifying source files...
        if not exist "src\MalayalamIME.cpp" (
          echo ERROR: MalayalamIME.cpp not found in src directory
          dir src
          exit 1
        )
        
        if not exist "src\Register.cpp" (
          echo ERROR: Register.cpp not found in src directory
          dir src
          exit 1
        )
        
        if not exist "src\MalayalamIME.def" (
          echo ERROR: MalayalamIME.def not found in src directory
          dir src
          exit 1
        )
        
        echo Source files verified
        echo.
        
        echo Starting compilation...
        echo ========================================
        
        cl /LD src\MalayalamIME.cpp src\Register.cpp ^
          /Fo$outputDir\ ^
          /I. ^
          /DWIN32_LEAN_AND_MEAN ^
          /DUNICODE ^
          /D_UNICODE ^
          /DWINVER=0x0601 ^
          /D_WIN32_WINNT=0x0601 ^
          /D_CRT_SECURE_NO_WARNINGS ^
          /D_MBCS ^
          /link /DLL ^
          /SUBSYSTEM:WINDOWS ^
          /OUT:$outputDir\MalayalamIME.dll ^
          /DEF:src\MalayalamIME.def ^
          user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib comctl32.lib
        
        if %ERRORLEVEL% EQU 0 (
          echo.
          echo ========================================
          echo    BUILD SUCCESSFUL!
          echo ========================================
          echo Output file: $outputDir\MalayalamIME.dll
          if exist "$outputDir\MalayalamIME.dll" (
            dir "$outputDir\MalayalamIME.dll"
          )
          exit 0
        ) else (
          echo.
          echo ========================================
          echo    BUILD FAILED!
          echo ========================================
          echo Check the error messages above
          exit 1
        )
        "@
        
        $buildScript | Out-File -FilePath "build-ime.bat" -Encoding ASCII
        Write-Host "Build script created: build-ime.bat"
        
        # Step 5: Execute build script
        Write-Host "Executing build script..."
        & cmd /c "build-ime.bat"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âœ— Primary build method failed, trying alternative approach..."
          
          # Alternative: Simple direct compilation
          Write-Host "Attempting direct compilation without build script..."
          
          # Set up environment and compile
          & $vcvars64 x64
          
          # Verify files exist
          if (!(Test-Path "src\MalayalamIME.cpp")) {
            Write-Host "âœ— ERROR: src\MalayalamIME.cpp not found!"
            exit 1
          }
          
          # Direct compilation command
          & cl /LD src\MalayalamIME.cpp src\Register.cpp /Fo$outputDir\ /DUNICODE /link /DLL /OUT:$outputDir\MalayalamIME.dll
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âœ— Alternative build also failed!"
            Write-Host "Final error: Build process completed with exit code $LASTEXITCODE"
            exit 1
          }
        }
        
        # Step 6: Verify output
        Write-Host "Verifying build output..."
        $dllPath = "$outputDir\MalayalamIME.dll"
        
        if (Test-Path $dllPath) {
          $fileInfo = Get-Item $dllPath
          Write-Host "âœ… SUCCESS: MalayalamIME.dll created!"
          Write-Host "File path: $dllPath"
          Write-Host "File size: $($fileInfo.Length) bytes"
          Write-Host "Created: $($fileInfo.LastWriteTime)"
          
          # List all output files
          Write-Host "Build output contents:"
          Get-ChildItem $outputDir\*
          
        } else {
          Write-Host "âŒ ERROR: Build output not found!"
          Write-Host "Checking for any DLL files:"
          Get-ChildItem -Recurse -Filter "*.dll" -Name
          Write-Host "Contents of output directory:"
          if (Test-Path $outputDir) {
            Get-ChildItem $outputDir\*
          } else {
            Write-Host "Output directory does not exist!"
          }
          exit 1
        }

    - name: Upload compiled DLL
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Enhanced-DLL
        path: |
          build-output/MalayalamIME.dll
          build-output/MalayalamIME.lib
          build-output/MalayalamIME.exp
        retention-days: 30

    - name: Upload source code
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Source-Files
        path: |
          src/
          docs/
          scripts/
          build-ime.bat
        retention-days: 30

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Error-Logs
        path: |
          build-ime.bat
          *.log
        retention-days: 30

    - name: Build Summary
      run: |
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "         MALAYALAM IME BUILD SUMMARY"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "Enhanced Chillu Character Support"
        Write-Host "Build Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        
        $dllFile = "build-output\MalayalamIME.dll"
        if (Test-Path $dllFile) {
          $fileSize = (Get-Item $dllFile).Length
          
          Write-Host "ğŸ‰ BUILD STATUS: SUCCESS"
          Write-Host "ğŸ“ Output: build-output/MalayalamIME.dll"
          Write-Host "ğŸ“ Size: $fileSize bytes"
          Write-Host ""
          Write-Host "âœ… Download compiled DLL from Artifacts"
          Write-Host "âœ… Ready for installation and testing"
          Write-Host ""
          Write-Host "ğŸ”§ Features Included:"
          Write-Host "   â€¢ Enhanced Chillu Character Support"
          Write-Host "   â€¢ 150+ Phonetic Mappings"
          Write-Host "   â€¢ Visual Studio 2022 Compilation"
          Write-Host "   â€¢ Unicode Support"
          Write-Host "   â€¢ Windows IME Compatible"
        } else {
          Write-Host "âŒ BUILD STATUS: FAILED"
          Write-Host "ğŸ” Check build logs for detailed error information"
          Write-Host "ğŸ“‹ Upload error logs from Artifacts for analysis"
        }
        
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
