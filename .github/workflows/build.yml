name: Build Malayalam IME

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio C++ tools
      run: |
        Write-Host "Setting up Visual Studio C++ environment..."
        
        # Find Visual Studio 2022 Enterprise installation path
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
          Write-Host "Visual Studio Path: $vsPath"
        }
        
        # Set up VCVARS environment
        $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
        Write-Host "VCVARS64 location: $vcvars64"
        
        # Create a batch file to set up environment properly
        $setupScript = @"
        @echo off
        echo Setting up Visual Studio environment...
        call "$vcvars64" x64
        echo VCVARS Environment Setup Complete
        echo CL Compiler: 
        where cl.exe
        exit 0
        "@
        
        $setupScript | Out-File -FilePath "setup-env.bat" -Encoding ASCII
        & cmd /c "setup-env.bat"

    - name: Display repository structure
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -Directory -Force | ForEach-Object { 
          Write-Host "Directory: $($_.FullName.Replace($env:GITHUB_WORKSPACE, ''))"
        }
        
        Write-Host "=== C++ Source Files ==="
        Get-ChildItem -Recurse -Filter "*.cpp" -Name
        Get-ChildItem -Recurse -Filter "*.h" -Name

    - name: Check for source files
      run: |
        Write-Host "Checking for Malayalam IME source files..."
        
        $cppFile = "src\MalayalamIME.cpp"
        $registerFile = "src\Register.cpp"
        
        if (Test-Path $cppFile) {
          Write-Host "âœ“ Found MalayalamIME.cpp"
        } else {
          Write-Host "âœ— ERROR: MalayalamIME.cpp not found!"
          Write-Host "Available files:"
          Get-ChildItem -Recurse -Filter "*.cpp" -Name
          exit 1
        }
        
        if (Test-Path $registerFile) {
          Write-Host "âœ“ Found Register.cpp"
        } else {
          Write-Host "âœ— ERROR: Register.cpp not found!"
          exit 1
        }

    - name: Find source directory
      id: find-source
      run: |
        Write-Host "Determining build directory..."
        
        $sourceDir = "src"
        if (Test-Path "$sourceDir\MalayalamIME.cpp") {
          Write-Host "Using src subdirectory structure"
        } else {
          Write-Host "âœ— ERROR: Source directory not found!"
          exit 1
        }
        
        Write-Host "Build directory: $sourceDir"
        Write-Host "##vso[task.setvariable variable=SOURCE_DIR;isOutput=true]$sourceDir"

    - name: Create build output directory
      run: |
        New-Item -ItemType Directory -Force -Path "build-output"
        Write-Host "Build output directory created"

    - name: Compile using MSBuild
      id: compile-msbuild
      run: |
        Write-Host "=== Attempting MSBuild Compilation ==="
        
        $sourceDir = "${{ steps.find-source.outputs.SOURCE_DIR }}"
        
        # First try with the solution file if it exists
        $solutionFile = "$sourceDir\MalayalamIME.sln"
        if (Test-Path $solutionFile) {
          Write-Host "Found solution file, building with MSBuild..."
          
          # Use MSBuild to build the solution
          & msbuild $solutionFile /p:Configuration=Release /p:Platform=x64 /p:OutputPath=..\build-output\
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ MSBuild compilation successful!"
            Write-Host "Build artifact created in build-output"
          } else {
            Write-Host "âœ— MSBuild compilation failed, trying alternative method..."
          }
        } else {
          Write-Host "No solution file found, will try direct compilation..."
        }
        
        # Set success flag
        if (Test-Path "build-output\*.dll") {
          Write-Host "##vso[task.setvariable variable=MSBUILD_SUCCESS;isOutput=true]true"
        } else {
          Write-Host "##vso[task.setvariable variable=MSBUILD_SUCCESS;isOutput=true]false"
        }

    - name: Direct compilation fallback
      if: steps.compile-msbuild.outputs.MSBUILD_SUCCESS != 'true'
      run: |
        Write-Host "=== Attempting Direct CL Compilation ==="
        
        $sourceDir = "${{ steps.find-source.outputs.SOURCE_DIR }}"
        
        # Set up Visual Studio environment
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
        $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
        
        # Change to source directory
        Set-Location $sourceDir
        
        # Create compilation batch script
        $compileScript = @"
        @echo off
        echo Compiling Malayalam IME...
        call "$vcvars64" x64
        echo Environment setup complete
        echo Compiling source files...
        
        cl /LD MalayalamIME.cpp Register.cpp ^
          /Fo..\build-output\ ^
          /DWIN32_LEAN_AND_MEAN ^
          /DUNICODE ^
          /D_UNICODE ^
          /DWINVER=0x0601 ^
          /D_WIN32_WINNT=0x0601 ^
          /link /DLL ^
          /SUBSYSTEM:WINDOWS ^
          /OUT:..\build-output\MalayalamIME.dll ^
          /DEF:MalayalamIME.def ^
          user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib
        
        if %ERRORLEVEL% EQU 0 (
          echo âœ“ Compilation successful!
          exit 0
        ) else (
          echo âœ— Compilation failed!
          exit 1
        )
        "@
        
        $compileScript | Out-File -FilePath "compile.bat" -Encoding ASCII
        
        # Run compilation
        & cmd /c "compile.bat"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âœ— Direct compilation also failed"
          exit 1
        } else {
          Write-Host "âœ“ Direct compilation successful!"
        }

    - name: Minimal compilation fallback
      if: failure()
      run: |
        Write-Host "=== Attempting Minimal Compilation ==="
        
        $sourceDir = "${{ steps.find-source.outputs.SOURCE_DIR }}"
        Set-Location $sourceDir
        
        # Simple compilation without complex dependencies
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
        $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
        
        & $vcvars64 x64
        
        # Minimal compilation
        & cl /LD MalayalamIME.cpp Register.cpp ^
          /Fo..\build-output\ ^
          /DUNICODE ^
          /D_CRT_SECURE_NO_WARNINGS ^
          /link /DLL ^
          /OUT:..\build-output\MalayalamIME.dll ^
          /DEF:MalayalamIME.def
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âœ— Minimal compilation failed"
          exit 1
        } else {
          Write-Host "âœ“ Minimal compilation successful!"
        }

    - name: Verify compilation output
      run: |
        Write-Host "=== Verifying Build Output ==="
        
        $dllFile = "build-output\MalayalamIME.dll"
        
        if (Test-Path $dllFile) {
          $fileSize = (Get-Item $dllFile).Length
          $lastModified = (Get-Item $dllFile).LastWriteTime
          
          Write-Host "âœ… SUCCESS: MalayalamIME.dll created!"
          Write-Host "File size: $fileSize bytes"
          Write-Host "Created: $lastModified"
          Write-Host "Location: $(Resolve-Path $dllFile)"
          
          # List all output files
          Write-Host "Build output files:"
          Get-ChildItem build-output\*
          
        } else {
          Write-Host "âŒ ERROR: MalayalamIME.dll not found in expected location!"
          Write-Host "Checking all DLL files in repository:"
          Get-ChildItem -Recurse -Filter "*.dll" -Name
          exit 1
        }

    - name: Upload compiled DLL
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Enhanced-Build
        path: |
          build-output/MalayalamIME.dll
          build-output/MalayalamIME.lib
          build-output/MalayalamIME.exp
          build-output/*.obj
        retention-days: 30

    - name: Upload source code
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Source-Code
        path: |
          src/
          docs/
          scripts/
        retention-days: 30

    - name: Build summary
      run: |
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "           BUILD SUMMARY"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "Enhanced Malayalam IME with Chillu Character Support"
        Write-Host "Build completed: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        
        $dllFile = "build-output\MalayalamIME.dll"
        if (Test-Path $dllFile) {
          $fileSize = (Get-Item $dllFile).Length
          
          Write-Host "ğŸ‰ Status: SUCCESS"
          Write-Host "ğŸ“ Output: build-output/MalayalamIME.dll"
          Write-Host "ğŸ“ Size: $fileSize bytes"
          Write-Host ""
          Write-Host "âœ… Download the compiled DLL from Artifacts"
          Write-Host "âœ… Ready for installation and testing"
          Write-Host ""
          Write-Host "ğŸ“‹ Features:"
          Write-Host "   â€¢ Enhanced Chillu Character Support"
          Write-Host "   â€¢ 150+ Phonetic Mappings"
          Write-Host "   â€¢ Visual Studio 2022 Compilation"
          Write-Host "   â€¢ Windows IME Compatible"
        } else {
          Write-Host "âŒ Status: FAILED"
          Write-Host "ğŸ” Check build logs for detailed error information"
        }
        
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
