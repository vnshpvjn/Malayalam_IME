name: Build Malayalam IME

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Visual Studio C++ components
      run: |
        Write-Host "Installing required Visual Studio C++ components..."
        
        # Install Windows SDK and C++ build tools
        $ProgressPreference = 'SilentlyContinue'
        
        # Check if chocolatey is available
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
          Write-Host "Installing Chocolatey..."
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        }
        
        # Install Windows SDK components
        Write-Host "Installing Windows SDK components..."
        choco install windows-sdk-10-version-2004-all -y
        choco install windows-sdk-10-version-21h1-all -y --force
        
        # Install additional Visual Studio components
        choco install visualstudio2022-workload-vctools -y
        choco install visualstudio2022-workload-desktopbuildtools -y
        
        Write-Host "Visual Studio components installation complete"

    - name: Display repository structure
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -Directory -Force | Select-Object -Property Name, FullName
        Write-Host "=== C++ Source Files ==="
        Get-ChildItem -Recurse -Filter "*.cpp" -Name
        Get-ChildItem -Recurse -Filter "*.h" -Name

    - name: Build with ATL Support
      run: |
        Write-Host "=== Building Malayalam IME with ATL Support ==="
        
        # Verify source files
        $requiredFiles = @(
          "src\MalayalamIME.cpp",
          "src\Register.cpp",
          "src\MalayalamIME.h",
          "src\MalayalamIME.def"
        )
        
        Write-Host "Verifying source files..."
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "âœ“ Found: $file"
          } else {
            Write-Host "âœ— ERROR: Missing required file: $file"
            exit 1
          }
        }
        
        # Find Visual Studio installation
        Write-Host "Finding Visual Studio 2022..."
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        
        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
          if (!$vsPath) {
            $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Community -latest -property installationPath
          }
          Write-Host "Visual Studio Path: $vsPath"
        } else {
          Write-Host "âœ— ERROR: Visual Studio 2022 not found!"
          exit 1
        }
        
        $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
        Write-Host "VCVARS64: $vcvars64"
        
        # Check for ATL headers
        $atlIncludePath = "${vsPath}\VC\ATLMFC\include"
        if (Test-Path $atlIncludePath) {
          Write-Host "âœ“ ATL Headers found at: $atlIncludePath"
        } else {
          Write-Host "âš  ATL Headers not found, trying to build without ATL..."
        }
        
        # Create output directory
        $outputDir = "build-output"
        if (!(Test-Path $outputDir)) {
          New-Item -ItemType Directory -Force -Path $outputDir
          Write-Host "Created output directory: $outputDir"
        }
        
        # Create comprehensive build script with ATL handling
        Write-Host "Creating build script with ATL handling..."
        $buildScript = @"
        @echo off
        echo ========================================
        echo   Malayalam IME Build (ATL Enhanced)
        echo ========================================
        
        echo Setting up Visual Studio environment...
        call "$vcvars64" x64
        if %ERRORLEVEL% NEQ 0 (
          echo ERROR: Failed to set up Visual Studio environment
          exit 1
        )
        
        echo Environment setup complete
        echo CL Compiler location:
        where cl.exe
        echo.
        
        echo Verifying source files...
        if not exist "src\MalayalamIME.cpp" (
          echo ERROR: MalayalamIME.cpp not found
          dir src
          exit 1
        )
        
        if not exist "src\Register.cpp" (
          echo ERROR: Register.cpp not found
          dir src
          exit 1
        )
        
        if not exist "src\MalayalamIME.def" (
          echo ERROR: MalayalamIME.def not found
          dir src
          exit 1
        )
        
        echo Source files verified
        echo.
        
        echo Starting compilation with ATL support...
        echo ========================================
        
        cl /LD src\MalayalamIME.cpp src\Register.cpp ^
          /Fo$outputDir\ ^
          /I. ^
          /I"$vsPath\VC\ATLMFC\include" ^
          /DWIN32_LEAN_AND_MEAN ^
          /DUNICODE ^
          /D_UNICODE ^
          /DWINVER=0x0601 ^
          /D_WIN32_WINNT=0x0601 ^
          /D_CRT_SECURE_NO_WARNINGS ^
          /D_MBCS ^
          /link /DLL ^
          /SUBSYSTEM:WINDOWS ^
          /OUT:$outputDir\MalayalamIME.dll ^
          /DEF:src\MalayalamIME.def ^
          user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib comctl32.lib atl.lib
        
        if %ERRORLEVEL% EQU 0 (
          echo.
          echo ========================================
          echo    BUILD SUCCESSFUL! (ATL Enhanced)
          echo ========================================
          echo Output file: $outputDir\MalayalamIME.dll
          if exist "$outputDir\MalayalamIME.dll" (
            dir "$outputDir\MalayalamIME.dll"
            echo File size: 
            for %%I in ("$outputDir\MalayalamIME.dll") do echo %%~zI bytes
          )
          exit 0
        ) else (
          echo.
          echo ========================================
          echo    ATL BUILD FAILED, TRYING ALTERNATIVE
          echo ========================================
          echo Trying compilation without ATL dependencies...
          
          rem Build without ATL headers
          cl /LD src\MalayalamIME.cpp src\Register.cpp ^
            /Fo$outputDir\ ^
            /I. ^
            /DWIN32_LEAN_AND_MEAN ^
            /DUNICODE ^
            /D_UNICODE ^
            /DWINVER=0x0601 ^
            /D_WIN32_WINNT=0x0601 ^
            /D_CRT_SECURE_NO_WARNINGS ^
            /D_MBCS ^
            /DNO_ATL_INCLUDES ^
            /link /DLL ^
            /SUBSYSTEM:WINDOWS ^
            /OUT:$outputDir\MalayalamIME.dll ^
            /DEF:src\MalayalamIME.def ^
            user32.lib kernel32.lib ole32.lib oleaut32.lib uuid.lib msctf.lib comctl32.lib
          
          if %ERRORLEVEL% EQU 0 (
            echo.
            echo ========================================
            echo    BUILD SUCCESSFUL! (No ATL)
            echo ========================================
            echo Output file: $outputDir\MalayalamIME.dll
            if exist "$outputDir\MalayalamIME.dll" (
              dir "$outputDir\MalayalamIME.dll"
            )
            exit 0
          ) else (
            echo.
            echo ========================================
            echo    ALL BUILD METHODS FAILED!
            echo ========================================
            echo Check the error messages above
            exit 1
          )
        )
        "@
        
        $buildScript | Out-File -FilePath "build-ime.bat" -Encoding ASCII
        Write-Host "Build script created: build-ime.bat"
        
        # Execute build script
        Write-Host "Executing ATL-enhanced build script..."
        & cmd /c "build-ime.bat"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âœ— Build script execution failed!"
          Write-Host "Checking build output anyway..."
        }

    - name: Verify build output
      run: |
        Write-Host "=== Verifying Build Output ==="
        
        $dllPath = "build-output\MalayalamIME.dll"
        $backupPaths = @(
          "build-output\MalayalamIME-*.dll",
          "build-output\*.dll"
        )
        
        $foundDll = $null
        
        # Check primary path
        if (Test-Path $dllPath) {
          $foundDll = $dllPath
          Write-Host "âœ“ Found primary DLL: $dllPath"
        } else {
          # Check backup paths
          foreach ($path in $backupPaths) {
            $dllFiles = Get-ChildItem -Path $path -ErrorAction SilentlyContinue
            if ($dllFiles.Count -gt 0) {
              $foundDll = $dllFiles[0].FullName
              Write-Host "âœ“ Found backup DLL: $foundDll"
              break
            }
          }
        }
        
        if ($foundDll) {
          $fileInfo = Get-Item $foundDll
          Write-Host "âœ… SUCCESS: MalayalamIME.dll created!"
          Write-Host "File path: $foundDll"
          Write-Host "File size: $($fileInfo.Length) bytes"
          Write-Host "Created: $($fileInfo.LastWriteTime)"
          Write-Host "MD5 Hash: $((Get-FileHash $foundDll -Algorithm MD5).Hash)"
          
          # List all output files
          Write-Host "Build output contents:"
          Get-ChildItem build-output\* | Format-Table Name, Length, LastWriteTime -AutoSize
          
          # Verify DLL is valid
          if ($fileInfo.Length -gt 1000) {
            Write-Host "âœ“ DLL size looks reasonable (>$($fileInfo.Length) bytes)"
          } else {
            Write-Host "âš  DLL size seems too small (=$($fileInfo.Length) bytes)"
          }
          
        } else {
          Write-Host "âŒ ERROR: No DLL file found in build output!"
          Write-Host "Checking all directories for DLL files:"
          Get-ChildItem -Recurse -Filter "*.dll" -Name
          Write-Host "Contents of build-output directory:"
          if (Test-Path "build-output") {
            Get-ChildItem build-output\* | Format-Table Name, Length, LastWriteTime -AutoSize
          } else {
            Write-Host "build-output directory does not exist!"
          }
          
          # Try minimal compilation as last resort
          Write-Host "Attempting minimal compilation as fallback..."
          
          $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Enterprise -latest -property installationPath
          if (!$vsPath) {
            $vsPath = & $vsWhere -products Microsoft.VisualStudio.Product.Community -latest -property installationPath
          }
          $vcvars64 = "${vsPath}\VC\Auxiliary\Build\vcvars64.bat"
          
          & $vcvars64 x64
          & cl /LD src\MalayalamIME.cpp Register.cpp /Fo$outputDir\ /link /DLL /OUT:$outputDir\MalayalamIME-minimal.dll /DEF:src\MalayalamIME.def
          
          if (Test-Path "$outputDir\MalayalamIME-minimal.dll") {
            Write-Host "âœ… Minimal compilation successful!"
            Copy-Item "$outputDir\MalayalamIME-minimal.dll" "$outputDir\MalayalamIME.dll"
          } else {
            exit 1
          }
        }

    - name: Upload compiled DLL
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Enhanced-DLL
        path: |
          build-output/MalayalamIME.dll
          build-output/MalayalamIME.lib
          build-output/MalayalamIME.exp
          build-output/*.obj
        retention-days: 30

    - name: Upload source code
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: MalayalamIME-Source-Files
        path: |
          src/
          docs/
          scripts/
          build-ime.bat
        retention-days: 30

    - name: Build Summary
      run: |
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "       MALAYALAM IME BUILD SUMMARY"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "Enhanced Chillu Character Support"
        Write-Host "Build Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        
        $dllFile = "build-output\MalayalamIME.dll"
        if (Test-Path $dllFile) {
          $fileSize = (Get-Item $dllFile).Length
          $hash = (Get-FileHash $dllFile -Algorithm MD5).Hash
          
          Write-Host "ğŸ‰ BUILD STATUS: SUCCESS"
          Write-Host "ğŸ“ Output: build-output/MalayalamIME.dll"
          Write-Host "ğŸ“ Size: $fileSize bytes"
          Write-Host "ğŸ” MD5: $hash"
          Write-Host ""
          Write-Host "âœ… Download compiled DLL from Artifacts"
          Write-Host "âœ… Ready for installation and testing"
          Write-Host ""
          Write-Host "ğŸ”§ Features Included:"
          Write-Host "   â€¢ Enhanced Chillu Character Support (150+ mappings)"
          Write-Host "   â€¢ ATL/Unicode Support"
          Write-Host "   â€¢ Visual Studio 2022 Compilation"
          Write-Host "   â€¢ COM Registration Support"
          Write-Host "   â€¢ Windows IME Compatible"
        } else {
          Write-Host "âŒ BUILD STATUS: FAILED"
          Write-Host "ğŸ” Check build logs for detailed error information"
          Write-Host "ğŸ“‹ Upload error logs from Artifacts for analysis"
        }
        
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
